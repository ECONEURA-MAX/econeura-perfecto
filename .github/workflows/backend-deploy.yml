name: Deploy Backend to Azure App Service

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: econeura-backend-prod
  AZURE_WEBAPP_PACKAGE_PATH: 'backend'
  NODE_VERSION: '20.x'

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Clean unnecessary files
      working-directory: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
      run: |
        echo "ðŸ§¹ Limpiando archivos innecesarios..."
        rm -rf __tests__ coverage *.test.js .env.local .git uploads backups data logs *.db *.sqlite *.log
        rm -rf node_modules  # Azure harÃ¡ npm install
        echo "âœ… Limpieza completada"

    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creando paquete de deployment..."
        cd backend
        zip -r ../backend-deploy.zip . \
          -x "*.git*" \
          -x "*node_modules*" \
          -x "*coverage*" \
          -x "*__tests__*" \
          -x "*.test.js" \
          -x "*.log"
        cd ..
        echo "âœ… Paquete creado: backend-deploy.zip"
        ls -lh backend-deploy.zip

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure Azure App Settings
      run: |
        echo "âš™ï¸ Configurando variables de entorno en Azure..."
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group appsvc_linux_northeurope_basic \
          --settings \
            NODE_ENV=production \
            PORT=8080 \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            OPENAI_API_BASE_URL="https://api.mammouth.ai/v1" \
            OPENAI_MODEL="mistral-medium-3.1" \
            CORS_ORIGIN="https://delightful-sand-04fd53203.3.azurestaticapps.net" \
            WEBSITE_NODE_DEFAULT_VERSION="20-lts" \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true
        echo "âœ… Variables de entorno configuradas"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD }}
        package: backend-deploy.zip

    - name: Wait for deployment and warm-up
      run: |
        echo "â³ Esperando que Azure complete el deployment..."
        sleep 120
        echo "âœ… Warm-up completado"

    - name: Health Check (8 attempts con backoff)
      run: |
        echo "ðŸ” Verificando health endpoint..."
        MAX_ATTEMPTS=8
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Intento $ATTEMPT/$MAX_ATTEMPTS..."
          
          # Probar endpoint simple primero
          simple_response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health/simple || echo "000")
          echo "  - Simple health: $simple_response"
          
          # Probar endpoint completo
          full_response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health || echo "000")
          echo "  - Full health: $full_response"
          
          if [ "$simple_response" = "200" ] || [ "$full_response" = "200" ]; then
            echo "âœ… Deployment exitoso - Health check OK"
            curl -s https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health | jq . || true
            exit 0
          fi
          
          # Backoff exponencial
          WAIT_TIME=$((10 + ATTEMPT * 5))
          echo "âš ï¸ Respuesta: simple=$simple_response full=$full_response, esperando ${WAIT_TIME}s..."
          sleep $WAIT_TIME
          ATTEMPT=$((ATTEMPT + 1))
        done
        
        echo "âŒ Health check fallÃ³ despuÃ©s de $MAX_ATTEMPTS intentos"
        echo "ðŸ“‹ Obteniendo logs de Azure..."
        az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group appsvc_linux_northeurope_basic | head -100 || true
        exit 1

    - name: Deployment Summary
      if: always()
      run: |
        echo "### ðŸš€ Backend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Backend URL:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "**Health Check:** https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health" >> $GITHUB_STEP_SUMMARY
        echo "**NEURAs:** 10 ejecutivas disponibles" >> $GITHUB_STEP_SUMMARY
        echo "**Database:** PostgreSQL Azure Flexible Server" >> $GITHUB_STEP_SUMMARY

